@model Library.Common.ViewModels.ListBooksViewModel;
@using Library.Common.ViewModels;
@using Library.Models;

<script type="text/javascript">
    $(document).ready(function () {

        var stringHeights = getStyle('text-Desc', 'font-size');
        var elm = document.getElementsByClassName('text-Desc');
        var lines = 0;

        var urlNames = $('.urlNames');

        $(document.body).on("click", ".del", function () {

            $('#ConfirmDelete').modal('show');
            $('#currentBook').val(this.id.substring(3));
        });



        $('#ConfirmBut').click(function () {
            var id = "id" + $('#currentBook').val();
            var bookId = document.getElementById(id).value;

            $.ajax({
                type: "POST",
                url: "/Library/Books/DeleteBook",
                data: { bookId: bookId },
                success: function () {
                    $('#h').html("Книга успешно удалена");
                    $('#ModalDialog').modal('show');
                }
            });
        });

        $('#ModalBut').click(function () {
            window.location.reload();
        });

        $('#DeleteBut').click(function () {
            window.location.reload();
        })

        $('#CancelBut').click(function () {
            $('#ConfirmDelete').modal('hide');
        })

        $('.ReturnBook').click(function () {
            var id = "#id" + this.id;
            var book = $(id).val();

            $.ajax({
                type: "POST",
                url: "ReturnBook",
                data: { bookId: book },
                success: function () {
                    $('#h').html("Вы успешно вернули книгу");
                    $('#ModalDialog').modal('show');
                }
            });
        });

        $('.ReceivingBook').click(function () {
            var id = "#id" + this.id;
            var book = $(id).val();

            $.ajax({
                type: "POST",
                url: "ReceivingBook",
                data: { bookId: book },
                success: function () {
                    $('#h').html("Книга взята для прочтения");
                    $('#ModalDialog').modal('show');
                }
            });
        });

        $('.notificationCreate').click(function () {
            var id = "#id" + this.id;
            var book = $(id).val();

            $.ajax({
                type: "POST",
                url: "CreateNotification",
                data: { bookId: book },
                success: function () {
                    $('#h').html("При появлении книги в наличии Вам будет отправлено уведомление");
                    $('#ModalDialog').modal('show');
                }
            });
        });

        for (var i = 0; i < urlNames.length; i++) {
            urlNames[i].value = document.location.href;
        }

        for (var i = 0; i < elm.length; i++) {
            var heightBlock = elm[i].clientHeight;
            lines = heightBlock / stringHeights[i];
            if (lines > 3) {
                elm[i].classList.add('hiddenText');
                var url = document.getElementById(i);
                url.classList.remove('hidden');
                url.classList.add('visible');
            }
        }


    })

</script>
<br />
@if (Model != null)
{
    <div class="flex">
        @for (int i = 0; i < Model.Books.ToArray().Length; i++)
        {
            BookViewModel book = Model.Books.ToArray()[i];
            <input type="hidden" id="currentBook" />
            <input type="hidden" id="@("id" + i)" value="@book.Id" />
            // Рисуем страницу для вида "Список"
            if (Model.PageView == 1)
            {
                <div class="flex-itm-1 flex-itm">

                    <div class="item">



                        <div class="img-item-1"><a asp-action="BookCard" asp-controller="Library" asp-route-bookId="@book.Id"><img style="border-radius: 5px;" width="100%" src="@((book.CoverBytes != null)? "data: image / jpeg; base64,"+(Convert.ToBase64String(book.CoverBytes)):"https://localhost:44372/img/No_Image.png") " /></a></div>

                        <div class="info-item-1">

                            <h6 class="info-1">

                                <a class="info-1" asp-action="BookCard" asp-controller="Library" asp-route-bookId="@book.Id"> @book.Title</a>

                                @if (!@User.IsInRole("User"))
                                {
                                    <i class="far fa-trash-alt del" id="@("del"+i)" style="float:right; color:black;"></i>
                                    <a asp-action="EditBook" asp-controller="Library" asp-route-bookId="@book.Id"><i class="fa fa-pencil-square-o" style="float:right;color:black;">&ensp;</i></a>
                                }

                            </h6>
                            <p class="info info-1"><b class="info info-1">Автор </b>@book.Author</p>
                            <p class="info info-1"><b class="info info-1">Год </b>@book.YearOfPublication  <b class="info info-1"> &ensp;&ensp;|&ensp;&ensp; Страниц </b>@book.CountPages <b class="info info-1">&ensp;&ensp;|&ensp;&ensp;Язык книги </b>@book.Language</p>
                            <p class="info info-1"><b class="info info-1">В наличии </b>@book.Count</p>
                            <p class="info-list">
                                <b class="info info-1">Категории:</b>
                                @foreach (var category in book.Categories)
                                {
                                    <u> @category</u><b>&ensp;</b>
                                }
                            </p>
                            <p class="info-list" style="margin-bottom:auto">
                                <b class="info info-1">Ключевые слова: </b>&ensp;
                                @foreach (var keyword in book.KeyWordsName)
                                {
                                    <u> @keyword</u><b>&ensp;</b>
                                }
                            </p>
                            <div class="flex">
                                @if (Model.HoldersList.Contains(book.Id))
                                {
                                    <button type="submit" class="btn btn-return btn-success ReturnBook" id="@i">Отдать</button>

                                }
                                else
                                {

                                    <button id="@i" class="btn btn-take ReceivingBook @((book.Count > 0) ?  "btn-success" : "btn-secondary")" @((book.Count > 0) ? "" : "disabled")>Взять</button>

                                }



                                <a class="btn @((book.URL != null) ? "":"btn-secondary disabled") btn-url" href="@book.URL">Читать онлайн</a>
                            </div>
                            @if (book.Count == 0)
                            {

                                <button id="@i" class="btn notificationCreate btn-notification-1 @((Model.NotificationList.Contains(book.Id)) ? "btn-secondary" :  "btn-success")" @((Model.NotificationList.Contains(book.Id)) ? "disabled" : "")>Уведомить о наличии</button>

                            }
                        </div>
                        <div class="Description-1"><p class="text-Desc">@book.Description</p> <p class="hidden" id="@i"><a class="bookCard" asp-action="BookCard" asp-controller="Library">Подробнее</a></p></div>
                    </div>

                </div>
            }
            // Рисуем страницу для вида "Плитка"
            else if (Model.PageView == 4)
            {
                <div class="flex-itm-4 flex-itm" style="@((i % 2 != 0) ? "margin-left:2%;":"") ">



                    <div class="item">


                        <div class="img-item-4"><a asp-action="BookCard" asp-controller="Library" asp-route-bookId="@book.Id"><img style="border-radius: 5px;" width="100%" src="@((book.CoverBytes != null)? "data: image / jpeg; base64,"+(Convert.ToBase64String(book.CoverBytes)):"https://localhost:44372/img/No_Image.png") " /></a></div>

                        <div class="info-item-4">

                            <h6 class="info">
                                <a class="info-4" asp-action="BookCard" asp-controller="Library" asp-route-bookId="@book.Id"> @book.Title</a>
                                @if (!@User.IsInRole("User"))
                                {
                                    <i class="far fa-trash-alt del" id="@("del" + i)" style="float:right; color:black;"></i>
                                    <a asp-action="EditBook" asp-controller="Library" asp-route-bookId="@book.Id"><i class="fa fa-pencil-square-o" style="float:right;color:black;">&ensp;</i></a>
                                }

                                </h6>
                            <p class="info info-4"><b class="info info-4">Автор </b>@book.Author</p>
                            <p class="info info-4"><b class="info info-4">Год </b>@book.YearOfPublication  <b class="info info-4"> &ensp;|&ensp; Страниц </b>@book.CountPages</p>
                            <p class="info info-4"><b class="info info-4">Язык книги </b>@book.Language</p>
                            <p class="info info-4"><b class="info info-4">В наличии </b>@book.Count</p>
                            <p class="info-list">
                                <b class="info info-4">Категории </b>&ensp;
                                @foreach (var category in book.Categories)
                                {
                                    <u> @category</u><b>&ensp;</b>

                                }
                            </p>
                            <p class="info-list" style="margin-bottom:auto">
                                <b class="info info-4">Ключевые слова </b>&ensp;
                                @foreach (var keyword in book.KeyWordsName)
                                {
                                    <u> @keyword</u><b>&ensp;</b>



                                }
                            </p>
                            <div class="flex">
                                @if (Model.HoldersList.Contains(book.Id))
                                {
                                    <button type="submit" class="btn btn-return btn-success ReturnBook" id="@i">Отдать</button>

                                }
                                else
                                {

                                    <button id="@i" class="btn btn-take ReceivingBook @((book.Count > 0) ?  "btn-success" : "btn-secondary")" @((book.Count > 0) ? "" : "disabled")>Взять</button>

                                }



                                <a class="btn @((book.URL != null) ? "":"btn-secondary disabled") btn-url" href="@book.URL">Читать онлайн</a>
                            </div>
                            @if (book.Count == 0)
                            {

                                <button id="@i" class="btn notificationCreate btn-notification-1 @((Model.NotificationList.Contains(book.Id)) ? "btn-secondary" :  "btn-success")" @((Model.NotificationList.Contains(book.Id)) ? "disabled" : "")>Уведомить о наличии</button>

                            }
                        </div>
                        <div class="Description"><p class="text-Desc">@book.Description</p><p class="hidden" id="@i"><a class="bookCard" asp-action="BookCard" asp-controller="Library">Подробнее</a></p></div>
                    </div>

                </div>
            }
            // Рисуем страницу для вида "Расширенная плитка"
            else
            {
                <div class="flex-itm-8 flex-itm">



                    <div class="item">


                        <div class="img-item-8"><a asp-action="BookCard" asp-controller="Library" asp-route-bookId="@book.Id"><img style="border-radius: 5px;" width="100%" src="@((book.CoverBytes != null)? "data: image / jpeg; base64,"+(Convert.ToBase64String(book.CoverBytes)):"https://localhost:44372/img/No_Image.png") " /></a></div>

                        <div class="info-item-8">

                            <p class="info-8"><a class="info-8" asp-action="BookCard" asp-controller="Library" asp-route-bookId="@book.Id">@book.Author - @book.Title</a> </p>

                        </div>
                    </div>

                </div>
            }

        }
    </div>
    <div class="row pagination">
        <div class="col-md-12 text-center">
            @{ Html.RenderPartialAsync("_Pagination", (Pagination)ViewBag.Pagination); }
        </div>
    </div>
}

<div id="ConfirmDelete" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title">Вы действительно хотите удалить эту книгу? </h4>
            </div>
            <br />
            <div class="modal-footer">
                <button id="ConfirmBut" type="button" class="btn btn-primary"> Подтвреждаю </button>
                <button id="CancelBut" type="button" class="btn btn-link"> Отмена </button>
            </div>
        </div>
    </div>
</div>

<div id="ModalDialog" class="modal fade">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <div class="modal-header">
                <h4 class="modal-title" id="h"></h4>
            </div>
            <br />
            <button id="ModalBut" type="button" class="btn btn-primary"> Ок </button>
            <button id="CancelBut" type="button" class="btn btn-primary"> Отмена </button>
        </div>
    </div>
</div>